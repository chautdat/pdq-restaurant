name: Database Backup

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  backup:
    name: Backup Database
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v3

      - name: ðŸ’¾ Backup MySQL Database
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            BACKUP_DIR="/var/backups/pdq-restaurant"
            DATE=$(date +%Y%m%d_%H%M%S)

            mkdir -p $BACKUP_DIR

            docker exec pdq-mysql mysqldump -u root -prootpassword pdq_restaurant > $BACKUP_DIR/backup_$DATE.sql

            gzip $BACKUP_DIR/backup_$DATE.sql

            find $BACKUP_DIR -name "backup_*.sql.gz" -mtime +7 -delete

            echo "âœ… Backup completed: backup_$DATE.sql.gz"

      - name: ðŸ“§ Notify Backup Status
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "ðŸ’¾ Database Backup ${{ job.status }}"
          body: |
            Database backup ${{ job.status }}!
            Time: ${{ github.event.repository.updated_at }}
          to: your-email@example.com
          from: PDQ Backup Bot
