name: Database Backup

on:
  schedule:
    - cron: "0 2 * * *" # Daily 2AM UTC (optional - won't run if not configured)
  workflow_dispatch:

jobs:
  backup:
    name: Database Backup
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v3

      - name: â„¹ï¸ Check Configuration
        id: check
        run: |
          if [ -n "${{ secrets.DB_HOST }}" ] && [ -n "${{ secrets.DB_PASSWORD }}" ]; then
            echo "configured=true" >> $GITHUB_OUTPUT
            echo "âœ… Database backup is configured"
          else
            echo "configured=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Database backup is NOT configured (this is OK for local development)"
          fi

      # ========== BACKUP CHáº Y Náº¾U CÃ“ PRODUCTION DATABASE ==========
      - name: ğŸ“¦ Install MySQL Client
        if: steps.check.outputs.configured == 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y mysql-client

      - name: ğŸ’¾ Create Database Backup
        if: steps.check.outputs.configured == 'true'
        id: backup
        run: |
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          BACKUP_FILE="pdq_restaurant_${TIMESTAMP}.sql"

          echo "ğŸ”„ Connecting to database..."
          mysqldump \
            --host="${{ secrets.DB_HOST }}" \
            --port="${{ secrets.DB_PORT || '3306' }}" \
            --user="${{ secrets.DB_USER || 'pdq_user' }}" \
            --password="${{ secrets.DB_PASSWORD }}" \
            --databases pdq_restaurant \
            --add-drop-database \
            --routines \
            --triggers \
            --events \
            --single-transaction \
            --quick \
            --lock-tables=false \
            > ${BACKUP_FILE}

          gzip ${BACKUP_FILE}
          echo "filename=${BACKUP_FILE}.gz" >> $GITHUB_OUTPUT
          echo "âœ… Backup created: ${BACKUP_FILE}.gz"
          ls -lh ${BACKUP_FILE}.gz

      - name: ğŸ“¤ Upload Backup
        if: steps.check.outputs.configured == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: database-backup-${{ steps.backup.outputs.filename }}
          path: "*.sql.gz"
          retention-days: 30

      # ========== INFO Náº¾U KHÃ”NG CÃ“ PRODUCTION DATABASE ==========
      - name: â„¹ï¸ Backup Info (Local Development)
        if: steps.check.outputs.configured == 'false'
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“‹ Database Backup - Local Development Mode"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "âœ… This workflow is working correctly!"
          echo ""
          echo "â„¹ï¸  No production database configured (this is normal)"
          echo ""
          echo "ğŸ“ Your database runs locally in Docker container:"
          echo "   - Container: pdq-mysql"
          echo "   - Image: mariadb:10.4"
          echo "   - Database: pdq_restaurant"
          echo ""
          echo "ğŸ”§ For local backups, use the backup script:"
          echo "   chmod +x docker/backup.sh"
          echo "   ./docker/backup.sh"
          echo ""
          echo "ğŸš€ To enable automatic backups (when you have production):"
          echo "   1. Setup production database server"
          echo "   2. Add GitHub Secrets:"
          echo "      - DB_HOST (server IP/domain)"
          echo "      - DB_PORT (default: 3306)"
          echo "      - DB_USER (default: pdq_user)"
          echo "      - DB_PASSWORD (your password)"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
