name: CD - Deploy

on:
  schedule:
    - cron: "0 2 * * *" # Daily 2AM UTC
  workflow_dispatch:
    inputs:
      backup_name:
        description: "Custom backup name"
        required: false
        default: "manual-backup"

jobs:
  backup:
    name: Backup MySQL Database
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v3

      - name: üè∑Ô∏è Set backup filename
        id: backup-info
        run: |
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          if [ "${{ github.event.inputs.backup_name }}" != "" ]; then
            BACKUP_NAME="${{ github.event.inputs.backup_name }}_${TIMESTAMP}"
          else
            BACKUP_NAME="pdq_restaurant_${TIMESTAMP}"
          fi
          echo "filename=${BACKUP_NAME}.sql" >> $GITHUB_OUTPUT
          echo "timestamp=${TIMESTAMP}" >> $GITHUB_OUTPUT

      - name: üì¶ Install MySQL Client
        run: |
          sudo apt-get update
          sudo apt-get install -y mysql-client

      - name: üíæ Create Database Backup
        run: |
          echo "üîÑ Connecting to database..."
          echo "Host: ${{ secrets.DB_HOST || 'localhost' }}"
          echo "Port: ${{ secrets.DB_PORT || '3306' }}"
          echo "User: ${{ secrets.DB_USER || 'root' }}"

          mysqldump \
            --host="${{ secrets.DB_HOST || 'localhost' }}" \
            --port="${{ secrets.DB_PORT || '3306' }}" \
            --user="${{ secrets.DB_USER || 'root' }}" \
            --password="${{ secrets.DB_PASSWORD }}" \
            --databases pdq_restaurant \
            --add-drop-database \
            --routines \
            --triggers \
            --events \
            --single-transaction \
            --quick \
            --lock-tables=false \
            > ${{ steps.backup-info.outputs.filename }} || {
              echo "‚ùå Backup failed!"
              echo "Please check:"
              echo "1. DB_HOST, DB_PORT, DB_USER, DB_PASSWORD secrets are set"
              echo "2. Database is accessible from GitHub Actions"
              echo "3. Database name 'pdq_restaurant' is correct"
              exit 1
            }

          echo "‚úÖ Backup created successfully!"
          ls -lh ${{ steps.backup-info.outputs.filename }}

      - name: üóúÔ∏è Compress backup
        run: |
          gzip ${{ steps.backup-info.outputs.filename }}
          echo "‚úÖ Backup compressed: ${{ steps.backup-info.outputs.filename }}.gz"
          ls -lh ${{ steps.backup-info.outputs.filename }}.gz

      - name: üì§ Upload to GitHub Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: database-backup-${{ steps.backup-info.outputs.timestamp }}
          path: ${{ steps.backup-info.outputs.filename }}.gz
          retention-days: 30

      - name: ‚úÖ Backup Summary
        if: success()
        run: |
          echo "=========================================="
          echo "‚úÖ Database Backup Successful"
          echo "=========================================="
          echo ""
          echo "üì¶ Backup file: ${{ steps.backup-info.outputs.filename }}.gz"
          echo "‚è∞ Timestamp: ${{ steps.backup-info.outputs.timestamp }}"
          echo "üì• Download: Go to Actions ‚Üí This workflow run ‚Üí Artifacts"
          echo ""
          echo "Retention: 30 days"
          echo "=========================================="

      - name: ‚ùå Backup Failed
        if: failure()
        run: |
          echo "=========================================="
          echo "‚ùå Database Backup Failed"
          echo "=========================================="
          echo ""
          echo "Troubleshooting:"
          echo "1. Check GitHub Secrets:"
          echo "   - DB_HOST (default: localhost)"
          echo "   - DB_PORT (default: 3306)"
          echo "   - DB_USER (default: root)"
          echo "   - DB_PASSWORD (REQUIRED)"
          echo ""
          echo "2. Verify database is accessible"
          echo "3. Check database name: pdq_restaurant"
          echo ""
          echo "Current values (masked):"
          echo "Host: ${{ secrets.DB_HOST || 'localhost' }}"
          echo "Port: ${{ secrets.DB_PORT || '3306' }}"
          echo "User: ${{ secrets.DB_USER || 'root' }}"
          echo "Password: ${{ secrets.DB_PASSWORD != '' && '‚úì Set' || '‚úó NOT SET' }}"
          echo "=========================================="
